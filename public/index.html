<!DOCTYPE html>
<html>
<head>
    <title>Kisii AgriPrice Admin</title>
    <style>
        body { font-family: Arial; max-width: 800px; margin: 50px auto; padding: 20px; }
        h1 { color: #2c5f2d; }
        .section { background: #f5f5f5; padding: 20px; margin: 20px 0; border-radius: 8px; }
        input { padding: 10px; margin: 5px; width: 150px; font-size: 16px; }
        button { padding: 12px 24px; background: #2c5f2d; color: white; border: none; 
                 border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px 5px; }
        button:hover { background: #1d4220; }
        .result { margin-top: 15px; padding: 10px; background: #fff; border-left: 4px solid #2c5f2d; }
        label { display: block; margin-top: 10px; font-weight: bold; }
    </style>
</head>
<div class="section">
    <h2>üìä SMS Logs</h2>
    <button onclick="viewLogs()">View SMS History</button>
    <div id="logs-result" class="result" style="display:none"></div>
</div>

<script>
async function viewLogs() {
    const res = await fetch('/admin/sms-logs');
    const data = await res.json();
    
    document.getElementById('logs-result').style.display = 'block';
    
    if (data.total === 0) {
        document.getElementById('logs-result').innerHTML = 'No SMS sent yet.';
        return;
    }
    
    let html = `<strong>Total SMS: ${data.total}</strong><br><br>`;
    data.logs.slice(-10).reverse().forEach(log => {
        const status = log.success ? '‚úÖ' : '‚ùå';
        html += `${status} ${log.phone} - ${new Date(log.timestamp).toLocaleString()}<br>`;
        if (log.error) html += `   Error: ${log.error}<br>`;
    });
    
    document.getElementById('logs-result').innerHTML = html;
}
</script>
<div class="section">
        <h2>üß™ Public SMS Test</h2>
        <p>Anyone can test the SMS system. Enter your phone number to receive sample market prices.</p>
        
        <label>Your Phone Number (with country code):</label>
        <input type="text" id="test-phone" placeholder="+254712345678">
        
        <br><button onclick="sendTestSMS()">Send Me Test SMS</button>
        <div id="test-result" class="result" style="display:none"></div>
    </div>

    <<script>
async function sendTestSMS() {
    const phone = document.getElementById('test-phone').value.trim();
    
    // Frontend validation
    if (!phone) {
        alert('Please enter a phone number');
        return;
    }
    
    if (!phone.startsWith('+254')) {
        alert('Phone number must start with +254\nExample: +254712345678');
        return;
    }
    
    if (phone.length !== 13) {
        alert('Invalid phone number length\nFormat: +254712345678 (13 characters)');
        return;
    }
    
    document.getElementById('test-result').style.display = 'block';
    document.getElementById('test-result').innerHTML = '‚è≥ Sending test SMS...';
    
    try {
        const res = await fetch('/test-sms', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ phone })
        });
        
        const data = await res.json();
        
        if (data.success) {
            document.getElementById('test-result').innerHTML = 
                `‚úÖ ${data.message}<br>Sent to: ${data.recipient}<br>Check your phone in 10-30 seconds.`;
            document.getElementById('test-phone').value = ''; // Clear input
        } else {
            document.getElementById('test-result').innerHTML = 
                '‚ùå ' + data.error;
        }
    } catch (error) {
        document.getElementById('test-result').innerHTML = 
            '‚ùå Network error: ' + error.message;
    }
}
</script>

<body>
<div id="authCheck" style="display:none;">
    <p>Checking authentication...</p>
</div>

<div id="logoutSection" style="text-align: right; padding: 10px; background: #f5f5f5;">
    <a href="/farmers.html" style="background: #2c5f2d; color: white; padding: 8px 16px; border-radius: 5px; text-decoration: none; margin-right: 10px;">
        üë• Manage Farmers
    </a>
    <button onclick="logout()" style="background: #d32f2f; color: white; padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer;">Logout</button>
</div>
<script>
// Check if user is authenticated
async function checkAuth() {
    try {
        const res = await fetch('/admin/check-auth');
        const data = await res.json();
        
        if (!data.isAuthenticated) {
            window.location.href = '/login.html';
        }
    } catch (error) {
        window.location.href = '/login.html';
    }
}

async function logout() {
    await fetch('/admin/logout', { method: 'POST' });
    window.location.href = '/login.html';
}

// Check auth on page load
checkAuth();
</script>
    <h1>üåæ Kisii AgriPrice - Admin Panel</h1>
    
    <div class="section">
        <h2>Update Market Prices</h2>
	<label>Bananas (KES/kg):</label>
	<input type="number" id="bananas" placeholder="30" step="0.01">

	<label>Potatoes (KES/kg):</label>
	<input type="number" id="potatoes" placeholder="40" step="0.01">

	<label>Avocados (KES/piece):</label>
	<input type="number" id="avocados" placeholder="15" step="0.01">

        <label>Maize (KES/kg):</label>
        <input type="number" id="maize" placeholder="45">
        
        <label>Beans (KES/kg):</label>
        <input type="number" id="beans" placeholder="80">
        
        <label>Tomatoes (KES/kg):</label>
        <input type="number" id="tomatoes" placeholder="60">
        
        <br><button onclick="updatePrices()">Update Prices</button>
        <button onclick="loadPrices()">Load Current Prices</button>
        <div id="price-result" class="result" style="display:none"></div>
    </div>
    
    <div class="section">
        <h2>Register New Farmer</h2>
        <label>Phone Number:</label>
        <input type="text" id="phone" placeholder="+254712345678">
        
        <label>Crops (comma separated):</label>
        <input type="text" id="crops" placeholder="maize,beans">
        
        <br><button onclick="registerFarmer()">Register Farmer</button>
        <div id="register-result" class="result" style="display:none"></div>
    </div>
    
    <div class="section">
        <h2>Send SMS to All Farmers</h2>
        <button onclick="sendSMS()">Send Price Update SMS Now</button>
        <button onclick="loadFarmers()">View Registered Farmers</button>
        <div id="sms-result" class="result" style="display:none"></div>
    </div>

    <script>
        async function updatePrices() { const prices = {
        maize: document.getElementById('maize').value,
        beans: document.getElementById('beans').value,
        tomatoes: document.getElementById('tomatoes').value,
        bananas: document.getElementById('bananas').value,
        potatoes: document.getElementById('potatoes').value,
        avocados: document.getElementById('avocados').value
    };
    
    const res = await fetch('/admin/prices', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(prices)
    });
    
    const data = await res.json();
    document.getElementById('price-result').style.display = 'block';
    document.getElementById('price-result').innerHTML = 
        `‚úÖ Prices updated! Maize: ${data.prices.maize}, Beans: ${data.prices.beans}, Tomatoes: ${data.prices.tomatoes}, Bananas: ${data.prices.bananas}, Potatoes: ${data.prices.potatoes}, Avocados: ${data.prices.avocados} KES`;
}
            
        
        async function loadPrices() {
	 const res = await fetch('/admin/prices');
    const data = await res.json();
    document.getElementById('maize').value = data.maize || 0;
    document.getElementById('beans').value = data.beans || 0;
    document.getElementById('tomatoes').value = data.tomatoes || 0;
    document.getElementById('bananas').value = data.bananas || 0;
    document.getElementById('potatoes').value = data.potatoes || 0;
    document.getElementById('avocados').value = data.avocados || 0;
}
           
        
        async function registerFarmer() {
            const phone = document.getElementById('phone').value;
            const crops = document.getElementById('crops').value.split(',');
            
            const res = await fetch('/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ phone, crops })
            });
            
            const data = await res.json();
            document.getElementById('register-result').style.display = 'block';
            document.getElementById('register-result').innerHTML = 
                `‚úÖ Farmer registered! Total farmers: ${data.total}`;
            document.getElementById('phone').value = '';
            document.getElementById('crops').value = '';
        }
        
        async function sendSMS() {
            if (!confirm('Send SMS to all farmers now?')) return;
            
            document.getElementById('sms-result').innerHTML = '‚è≥ Sending...';
            document.getElementById('sms-result').style.display = 'block';
            
            const res = await fetch('/send-sms', { method: 'POST' });
            const data = await res.json();
            
            document.getElementById('sms-result').innerHTML = 
                `‚úÖ SMS sent to ${data.sent} farmers! Failed: ${data.failed}`;
        }
        
        async function loadFarmers() {
            const res = await fetch('/farmers');
            const data = await res.json();
            document.getElementById('sms-result').style.display = 'block';
            document.getElementById('sms-result').innerHTML = 
                `üìä Total registered farmers: ${data.count}`;
        }
        
        // Load prices on page load
        loadPrices();
    </script>
</body>
</html>