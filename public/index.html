<!DOCTYPE html>
<html>
<head>
    <title>Kisii AgriPrice Admin</title>
    <style>
        body { font-family: Arial; max-width: 800px; margin: 50px auto; padding: 20px; }
        h1 { color: #2c5f2d; }
        .section { background: #f5f5f5; padding: 20px; margin: 20px 0; border-radius: 8px; }
        input { padding: 10px; margin: 5px; width: 150px; font-size: 16px; }
        button { padding: 12px 24px; background: #2c5f2d; color: white; border: none; 
                 border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px 5px; }
        button:hover { background: #1d4220; }
        .result { margin-top: 15px; padding: 10px; background: #fff; border-left: 4px solid #2c5f2d; }
        label { display: block; margin-top: 10px; font-weight: bold; }
    </style>
</head>
<div class="section">
    <h2>üìä SMS Logs</h2>
    <button onclick="viewLogs()">View SMS History</button>
    <div id="logs-result" class="result" style="display:none"></div>
</div>

<script>
async function viewLogs() {
    const res = await fetch('/admin/sms-logs');
    const data = await res.json();
    
    document.getElementById('logs-result').style.display = 'block';
    
    if (data.total === 0) {
        document.getElementById('logs-result').innerHTML = 'No SMS sent yet.';
        return;
    }
    
    let html = `<strong>Total SMS: ${data.total}</strong><br><br>`;
    data.logs.slice(-10).reverse().forEach(log => {
        const status = log.success ? '‚úÖ' : '‚ùå';
        html += `${status} ${log.phone} - ${new Date(log.timestamp).toLocaleString()}<br>`;
        if (log.error) html += `   Error: ${log.error}<br>`;
    });
    
    document.getElementById('logs-result').innerHTML = html;
}
</script>
<div class="section">
        <h2>üß™ Public SMS Test</h2>
        <p>Anyone can test the SMS system. Enter your phone number to receive sample market prices.</p>
        
        <label>Your Phone Number (with country code):</label>
        <input type="text" id="test-phone" placeholder="+254712345678">
        
        <br><button onclick="sendTestSMS()">Send Me Test SMS</button>
        <div id="test-result" class="result" style="display:none"></div>
    </div>

    <<script>
async function sendTestSMS() {
    const phone = document.getElementById('test-phone').value.trim();
    
    // Frontend validation
    if (!phone) {
        alert('Please enter a phone number');
        return;
    }
    
    if (!phone.startsWith('+254')) {
        alert('Phone number must start with +254\nExample: +254712345678');
        return;
    }
    
    if (phone.length !== 13) {
        alert('Invalid phone number length\nFormat: +254712345678 (13 characters)');
        return;
    }
    
    document.getElementById('test-result').style.display = 'block';
    document.getElementById('test-result').innerHTML = '‚è≥ Sending test SMS...';
    
    try {
        const res = await fetch('/test-sms', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ phone })
        });
        
        const data = await res.json();
        
        if (data.success) {
            document.getElementById('test-result').innerHTML = 
                `‚úÖ ${data.message}<br>Sent to: ${data.recipient}<br>Check your phone in 10-30 seconds.`;
            document.getElementById('test-phone').value = ''; // Clear input
        } else {
            document.getElementById('test-result').innerHTML = 
                '‚ùå ' + data.error;
        }
    } catch (error) {
        document.getElementById('test-result').innerHTML = 
            '‚ùå Network error: ' + error.message;
    }
}
</script>

<body>
<div id="authCheck" style="display:none;">
    <p>Checking authentication...</p>
</div>

<div id="logoutSection" style="text-align: right; padding: 10px; background: #f5f5f5;">
    <a href="/farmers.html" style="background: #2c5f2d; color: white; padding: 8px 16px; border-radius: 5px; text-decoration: none; margin-right: 10px;">
        üë• Manage Farmers
    </a>
    <button onclick="logout()" style="background: #d32f2f; color: white; padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer;">Logout</button>
</div>
<script>
// Check if user is authenticated
async function checkAuth() {
    try {
        const res = await fetch('/admin/check-auth');
        const data = await res.json();
        
        if (!data.isAuthenticated) {
            window.location.href = '/login.html';
        }
    } catch (error) {
        window.location.href = '/login.html';
    }
}

async function logout() {
    await fetch('/admin/logout', { method: 'POST' });
    window.location.href = '/login.html';
}

// Check auth on page load
checkAuth();
</script>
<!-- Stats Dashboard -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0;">
    <div style="background: linear-gradient(135deg, #2c5f2d, #4a9c4f); color: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
        <div style="font-size: 36px; font-weight: bold;" id="statFarmers">0</div>
        <div style="margin-top: 5px; opacity: 0.9;">Total Farmers</div>
    </div>
    
    <div style="background: linear-gradient(135deg, #1976d2, #42a5f5); color: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
        <div style="font-size: 36px; font-weight: bold;" id="statSMS">0</div>
        <div style="margin-top: 5px; opacity: 0.9;">SMS Sent</div>
    </div>
    
    <div style="background: linear-gradient(135deg, #f57c00, #ffa726); color: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
        <div style="font-size: 36px; font-weight: bold;" id="statSuccess">0%</div>
        <div style="margin-top: 5px; opacity: 0.9;">Success Rate</div>
    </div>
    
    <div style="background: linear-gradient(135deg, #7b1fa2, #ab47bc); color: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
        <div style="font-size: 18px; font-weight: bold;" id="statLastUpdate">Never</div>
        <div style="margin-top: 5px; opacity: 0.9;">Last Price Update</div>
    </div>
</div>
    <h1>üåæ Kisii AgriPrice - Admin Panel</h1>
    
    <div class="section">
        <h2>Update Market Prices</h2>
	<label>Maize (KES/kg):</label>
	<input type="number" id="maize" placeholder="45" min="0" step="1">

	<label>Beans (KES/kg):</label>
	<input type="number" id="beans" placeholder="80" min="0" step="1">

	<label>Tomatoes (KES/kg):</label>
	<input type="number" id="tomatoes" placeholder="60" min="0" step="1">

	<label>Bananas (KES/kg):</label>
	<input type="number" id="bananas" placeholder="30" min="0" step="1">

	<label>Potatoes (KES/kg):</label>
	<input type="number" id="potatoes" placeholder="40" min="0" step="1">

	<label>Avocados (KES/piece):</label>
	<input type="number" id="avocados" placeholder="15" min="0" step="1">        
        <br><button onclick="updatePrices()">Update Prices</button>
        <button onclick="loadPrices()">Load Current Prices</button>
        <div id="price-result" class="result" style="display:none"></div>
    </div>
    <div class="section">
    <h2>Register New Farmer</h2>
    <label>Farmer Name:</label>
    <input type="text" id="farmerName" placeholder="e.g., John Mwangi">
    
    <label>Phone Number:</label>
    <input type="text" id="phone" placeholder="+254712345678">
    
    <label>Crops (comma separated):</label>
    <input type="text" id="crops" placeholder="maize,beans">
    
    <br><button onclick="registerFarmer()">Register Farmer</button>
    <div id="register-result" class="result" style="display:none"></div>
</div>

    <script>
       async function updatePrices() {
    const prices = {
        maize: parseInt(document.getElementById('maize').value) || 0,
        beans: parseInt(document.getElementById('beans').value) || 0,
        tomatoes: parseInt(document.getElementById('tomatoes').value) || 0,
        bananas: parseInt(document.getElementById('bananas').value) || 0,
        potatoes: parseInt(document.getElementById('potatoes').value) || 0,
        avocados: parseInt(document.getElementById('avocados').value) || 0
    };
    
    const res = await fetch('/admin/prices', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        credentials: 'include',
        body: JSON.stringify(prices)
    });
    
    const data = await res.json();
    document.getElementById('price-result').style.display = 'block';
    document.getElementById('price-result').innerHTML = 
        `‚úÖ Prices updated! Maize: ${data.prices.maize}, Beans: ${data.prices.beans}, Tomatoes: ${data.prices.tomatoes}, Bananas: ${data.prices.bananas}, Potatoes: ${data.prices.potatoes}, Avocados: ${data.prices.avocados} KES`;
}
            
        
        async function loadPrices() {
    try {
        const res = await fetch('/admin/prices', {
            credentials: 'include'
        });
        const data = await res.json();
        
        document.getElementById('maize').value = parseInt(data.maize) || 0;
        document.getElementById('beans').value = parseInt(data.beans) || 0;
        document.getElementById('tomatoes').value = parseInt(data.tomatoes) || 0;
        document.getElementById('bananas').value = parseInt(data.bananas) || 0;
        document.getElementById('potatoes').value = parseInt(data.potatoes) || 0;
        document.getElementById('avocados').value = parseInt(data.avocados) || 0;
        
        console.log('Prices loaded:', data);
    } catch (error) {
        console.error('Error loading prices:', error);
    }
}
           
        async function registerFarmer() {
    const name = document.getElementById('farmerName').value.trim();
    const phone = document.getElementById('phone').value;
    const crops = document.getElementById('crops').value.split(',');
    
    if (!name) {
        alert('Please enter farmer name');
        return;
    }
    
    const res = await fetch('/register', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        credentials: 'include',
        body: JSON.stringify({ name, phone, crops })
    });
    
    const data = await res.json();
    document.getElementById('register-result').style.display = 'block';
    if (data.success) {
        document.getElementById('register-result').innerHTML = 
            `‚úÖ ${name} registered! Total farmers: ${data.total}`;
        document.getElementById('farmerName').value = '';
        document.getElementById('phone').value = '';
        document.getElementById('crops').value = '';
    } else {
        document.getElementById('register-result').innerHTML = '‚ùå ' + data.error;
    }
}
        
        async function sendSMS() {
            if (!confirm('Send SMS to all farmers now?')) return;
            
            document.getElementById('sms-result').innerHTML = '‚è≥ Sending...';
            document.getElementById('sms-result').style.display = 'block';
            
            const res = await fetch('/send-sms', { method: 'POST' });
            const data = await res.json();
            
            document.getElementById('sms-result').innerHTML = 
                `‚úÖ SMS sent to ${data.sent} farmers! Failed: ${data.failed}`;
        }
        
        async function loadFarmers() {
            const res = await fetch('/farmers');
            const data = await res.json();
            document.getElementById('sms-result').style.display = 'block';
            document.getElementById('sms-result').innerHTML = 
                `üìä Total registered farmers: ${data.count}`;
        }
        
        // Load prices on page load
        loadPrices();
    </script>
<script>
// Load stats on page load
async function loadStats() {
    try {
        // Get farmers count
        const farmersRes = await fetch('/farmers');
        const farmersData = await farmersRes.json();
        document.getElementById('statFarmers').textContent = farmersData.count || 0;
        
        // Get SMS logs
        const logsRes = await fetch('/admin/sms-logs', {
            credentials: 'include'
        });
        const logsData = await logsRes.json();
        
        const totalSMS = logsData.total || 0;
        document.getElementById('statSMS').textContent = totalSMS;
        
        // Calculate success rate
        if (totalSMS > 0) {
            const successful = logsData.logs.filter(log => log.success).length;
            const successRate = Math.round((successful / totalSMS) * 100);
            document.getElementById('statSuccess').textContent = successRate + '%';
        }
        
        // Get last price update from prices
        const pricesRes = await fetch('/admin/prices');
        const pricesData = await pricesRes.json();
        
        // Check if prices.json has lastUpdated field
        if (pricesData.lastUpdated) {
            const date = new Date(pricesData.lastUpdated);
            const timeAgo = getTimeAgo(date);
            document.getElementById('statLastUpdate').textContent = timeAgo;
        }
        
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

function getTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    
    if (seconds < 60) return 'Just now';
    if (seconds < 3600) return Math.floor(seconds / 60) + ' mins ago';
    if (seconds < 86400) return Math.floor(seconds / 3600) + ' hours ago';
    return Math.floor(seconds / 86400) + ' days ago';
}

// Load stats when page loads (after auth check)
checkAuth().then(() => {
    loadStats();
    loadPrices();
});
</script>
</body>
</html>